<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Взять в работу — safe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://api.bitrix24.com/api/v1/"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:14px;color:#222}
    pre{background:#f7f7f7;border:1px solid #e1e1e1;padding:10px}
    button{padding:8px 12px;margin-right:8px}
    .warn{color:#b23}
  </style>
</head>
<body>
  <h2>Взять в работу — безопасный режим</h2>
  <div>Статус: <b id="status">инициализация...</b></div>
  <div class="small">URL: <span id="url"></span></div>

  <h4>Лог:</h4>
  <pre id="log">...</pre>

  <div style="margin-top:10px">
    <button id="btnDump" disabled>Показать context / user.current</button>
    <button id="btnRun" disabled>Выполнить: назначить меня</button>
  </div>

<script>
  const LOG = document.getElementById('log');
  const STATUS = document.getElementById('status');
  const urlSpan = document.getElementById('url');
  const btnDump = document.getElementById('btnDump');
  const btnRun = document.getElementById('btnRun');

  urlSpan.innerText = location.href;
  function log(msg){ LOG.innerText += msg + "\n"; console.log(msg); }
  function setStatus(s){ STATUS.innerText = s; }

  // Настрой: замените на реальный код статуса вашей воронки
  const TARGET_STATUS_ID = 'NEW';

  // Безопасные проверки для BX24:
  function hasBX24(){
    return (typeof BX24 !== 'undefined' && BX24 !== null);
  }
  function hasBX24Init(){
    return hasBX24() && typeof BX24.init === 'function';
  }
  function hasBX24Call(){
    return hasBX24() && typeof BX24.callMethod === 'function';
  }

  // Попытка инициализации если доступно
  try {
    if(hasBX24Init()){
      setStatus('BX24 SDK обнаружен — вызываем init()');
      BX24.init(function(){
        setStatus('BX24.init выполнен');
        log('BX24.init callback OK');
        btnDump.disabled = false;
        btnRun.disabled = false;
      });
    } else if(hasBX24()){
      setStatus('BX24 переменная есть, но init отсутствует');
      log('BX24 присутствует но BX24.init отсутствует: ' + JSON.stringify(BX24));
      btnDump.disabled = false;
      // не включаем btnRun, пока не удостоверимся, что callMethod есть
      if(hasBX24Call()) btnRun.disabled = false;
    } else {
      setStatus('BX24 отсутствует (вы открыли страницу вне Bitrix)');
      log('BX24 SDK не обнаружен. Вызовы REST будут недоступны вне Bitrix слайдера.');
      btnDump.disabled = false; // даём возможность посмотреть query params
    }
  } catch(e){
    setStatus('Ошибка при инициализации BX24');
    log('Ошибка при инициализации BX24: ' + e);
  }

  // Dump: покажем query params и, если возможно, user.current и placement.info
  btnDump.onclick = function(){
    log('location.search: ' + location.search);
    const q = {};
    location.search.replace(/^\?/, '').split('&').forEach(function(p){
      if(!p) return;
      const kv = p.split('=');
      q[decodeURIComponent(kv[0])] = decodeURIComponent((kv[1]||''));
    });
    log('Query params: ' + JSON.stringify(q, null, 2));

    if(hasBX24Call()){
      try {
        BX24.callMethod('user.current', {}, function(res){
          if(res.error()){
            log('user.current error: ' + JSON.stringify(res.error()));
          } else {
            log('user.current: ' + JSON.stringify(res.data(), null, 2));
          }
        });
      } catch(e){ log('user.current call failed: ' + e); }

      try {
        if(typeof BX24.placement !== 'undefined' && typeof BX24.placement.info === 'function'){
          BX24.placement.info(function(ctx){ log('placement.info: ' + JSON.stringify(ctx, null, 2)); });
        } else {
          log('BX24.placement.info недоступен в этом контексте.');
        }
      } catch(e){ log('placement.info error: ' + e); }
    } else {
      log('BX24.callMethod недоступен — cannot call user.current or crm.');
    }
  };

  // Основная кнопка — безопасные проверки перед вызовом
  btnRun.onclick = function(){
    if(!hasBX24Call()){
      log('BX24.callMethod недоступен — операция отменена.');
      return;
    }
    // Сначала получаем placement.id (если есть)
    let leadId = null;
    try {
      BX24.placement.info(function(ctx){
        log('placement.info => ' + JSON.stringify(ctx, null, 2));
        const opts = ctx && (ctx.PLACEMENT_OPTIONS || ctx.placementOptions || {});
        leadId = opts && (opts.id || opts.ID || opts.entityId || opts.ITEM_ID || opts.leadId);
        if(!leadId){
          log('ID сущности не найден в PLACEMENT_OPTIONS. Остановка.');
          return;
        }
        log('Найден leadId=' + leadId);
        // Получаем текущего пользователя
        BX24.callMethod('user.current', {}, function(resUser){
          if(resUser.error()){
            log('user.current error: ' + JSON.stringify(resUser.error()));
            return;
          }
          const user = resUser.data();
          const userId = user && user.ID;
          log('userId=' + userId + '; выполняем crm.lead.update...');
          BX24.callMethod('crm.lead.update', {
            id: leadId,
            fields: {
              ASSIGNED_BY_ID: userId,
              STATUS_ID: TARGET_STATUS_ID
            }
          }, function(resUpd){
            if(resUpd.error()){
              log('crm.lead.update error: ' + JSON.stringify(resUpd.error()));
              return;
            }
            log('crm.lead.update success: ' + JSON.stringify(resUpd.data()));
            setStatus('Готово — лид обновлён');
            try{ BX24.closeWindow(); }catch(e){}
          });
        });
      });
    } catch(e){
      log('Ошибка при выполнении: ' + e);
    }
  };

  // Глобальный перехват ошибок
  window.addEventListener('error', function(e){ log('[window.error] ' + e.message + ' at ' + e.filename + ':' + e.lineno); });
  window.addEventListener('unhandledrejection', function(e){ log('[unhandledrejection] ' + JSON.stringify(e.reason)); });

</script>
</body>
</html>
